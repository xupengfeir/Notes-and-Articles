# 高级定时器TIM工作原理及SVPWM生成

高级定时器（TIM1和TIM8）和通用定时器在基本定时器的基础上引入了外部引脚，可以实现输入捕获和输出比较的功能。高级定时器比通用定时器增加了可编程死区互补输出、重复计数器、带刹车（断路，BKIN）功能，这些功能都是针对工业电机控制方面。


## 1、时基单元及寄存器
高级定时器实际单元如下图所示

![20240124161535](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124161535.png)

高级定时器实际单元包含一个16位自动重装载寄存器ARR；一个16位的计数器CNT，可向上/向下计数；一个16位的可编程预分频器PSC，有内部、外部时钟可选；还有一个8位的重复计数器RCR（高级TIM独有）。这样最高可实现40位（16+8+16，ARR+RCR+CNT）的可编程定时。

### 1.1预分频器PSC
预分频器PSC，有一个输入时钟CK_PSC和一个输出时钟CK_CNT就是上面时钟源的输出，输出CK_CNT则用来驱动计数器CNT计数。通过设置预分频器PSC的值可以得到不同的CK_CNT，实际计算为等于/(PSC[15:0]+1)，可实现1至65536分频。

### 1.2计数器CNT
高级定时器的计数器有三种计数模式，分别为递增计数模式、递减计数模式和递增/递减（中心对齐）计数模式。

（1）递增计数模式：计数器从0开始计数，每来一个CK_CNT脉冲计数器加1，直至计数器的值与自动重装载寄存器ARR相等，然后计数器又从0开始并生成计数器上溢事件，计数器总是如此循环计数。如果禁用重复计数器（RCR），在计数器生成上溢事件就马上生成更新事件；如果使能重复计数器，每生成一次上溢事件重复计数器数值减1，知道重复计数器值为0，才会生成更新事件。

(2) 递减计数模式：计数器从自动重装载寄存器ARR值开始计数，每来一个CK_CNT脉冲计数器就减1，直到计数器值为0，然 后计数器又从自动重载寄存器ARR值开始递减计数并生成计数器下溢事件，计数器总是如此循环计数。如果禁用重复计数器， 在计数器生（2）成下溢事件就马上生成更新事件；如果使能重复计数器，每生成一次下溢事件重复计数器内容就减1，直到重复计数器内容为0时才会生成更新事件。

（3）中心对齐模式：计数器从0开始递增计数，直到计数值等于（ARR-1）值生成计数器上溢事件（0\~ARR-1），然后从ARR值开始递减计数直到1生成计数器下溢事件。然后又从0开始计数，如此循环（ARR\~1）。如果禁用重复计数器， 在计数器生成下溢事件就马上生成更新事件；如果使能重复计数器，每生成一次下溢事件重复计数器内容就减1，直到重复计数器内容为0时才会生成更新事件。

### 1.3自动重装载寄存器ARR

自动重装载寄存器ARR用来存放与计数器CNT比较的值，如果两个值相等就递减重复计数器。可以通过TIMx_CR1寄存器的ARPE位控制自动重载影子寄存器。如果ARPE位置1，自动重载影子寄存器有效，只有在事件更新时间才把TIMx_ARR值赋给影子寄存器。如果ARPE位为0，则修改TIMx_ARR的值后立马有效。
### 1.4重复计数器RCR

在基本/通用定时器发生上/下溢事件时直接就生成更新事件，但对于高级控制定时器却不是这样，高级控制定时器在硬件结构上多出了重复计数器。在定时器发生上溢或下溢事件时，递减重复计数器的值，只有当重复计数器为0时才会发生更新事件。在发生N+1个上溢或下溢事件（N为RCR的值）时产生更新事件。

## 2、SVPWM产生
在SVPWM调制中，为保证PWM波的中心和ARR对应的位置对齐，一般使用中心对齐模式。中心对齐模式又分为中心对齐模式1/2/3 三种，具体由寄存器CR1位CMS[1:0]配置。具体的区别就是比较中断中断标志位CCxIF在何时置1：中心模式1在CNT递减计数的时候置1，中心对齐模式2在CNT递增计数时置1，中心模式3在CNT递增和递减计数时都置1。

在比较中断发生时，中断服务程序（ISP）将会执行。在ISR中，通常需要清除相应的比较中断标志位（CCxIF），以便下一次比较中断能够正确触发。

![20240124161811](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124161811.png)

### 2.1 设置PWM通道
由于三相逆变器有三个桥臂，为防止逆变器上下桥臂直通，在生成6路PWM信号时需要注意死区时间。并且应添加断路功能。以ST系列为例，下面给出两种方案。

![20240124161846](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124161846.png)

**方案一：定时器TIM1互补输出**

使用TIM1的通道1（PA8）及其互补通道（PB13）作为输出通道，为增加断路功能，需要用到TIM1_BKIN引脚（PB12）。系统复位启动默认关闭断路功能，将断路和死区寄存器TIMx_BDTR的BKE位置1，使能断路功能；通过TIMx_BDTR寄存器的BKP位设置断路输入引脚的有效电平，置1时输入BKP高电平有效，否则低电平有效。当程序上设置断路引脚为高电平有效，当BKIN引脚被置高电平时，两路互补的PWM输出停止，电机停止动作。

在生成的参考波形OCxREF的基础上，可以插入死区时间，用于生成两路互补的输出信号OCx和OCxN，死区时间的大小具体由BDTR寄存器的位DTG[7:0]配置。死区时间的大小必须根据与输出信号相连接的器件及其特性来调整。

TIM1其余的两个通道的共四路输出和通道1类似。

**方案二：定时器TIM1普通输出（非互补）**

MCU的TIM1三个通道1/2/3的主输出输出PWM信号，有电机的驱动芯片（例如STSPIN810）在该三路PWM信号上生成对应的互补PWM输出共六路，三对带死区和断路的互补PWM。

**PWM通道模式：**
根据需求自行设置，这里设置mode=1，即模式1，向下计数时产生比较中断。

**RCR：**
在SVPWM调制中，使用中心对齐模式，mode=1，向下计数时产生比较中断。为保证相邻两个更新事件的触发时间和PWM波周期相等，寄存器RCR=1，因此当计数器发生RCR+1=2次溢出动作（一次上溢，一次下溢）后，触发更新事件。此时计数器的计数过程是周期为Ts的三角波。

![20240124162021](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124162021.png)![20240124162028](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124162028.png)

**ARR：**
在中心对齐模式下，有计算公式：

$$T_s=2\frac{1}{T_{CNT}}ARR=\frac{2ARR(PSC+1)}{T_p}$$

$$\Rightarrow f_{PWM}=\frac{1}{T_s}=\frac{T_p}{2ARR(PSC+1)}$$

式中，Ts是PWM周期， $T_p$ 是分频器输入的内部时钟（单位MHz）， $T_{CNT}$ 是分频后的时钟（MHz）， $T_{CNT}$作为计数器的计数频率。ARR是自动重装载寄存器的值，PSC是分频值。

**CCR：**
比较寄存器CCR设置由用户根据实际运行情况计算得到。

![20240124162451](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124162451.png)

**影子寄存器：**

**ARR：**
禁止使用预装载寄存器，ARR值更新后得直接加载到影子寄存器（运行的实时性要求）；

**CCR：**
使能预装载寄存器，CCR值更新后存放在预装载寄存器OCR中，在下一个更新事件到来时再将OCR数据加载到影子寄存器（保证周期内PWM波形的对称性和完整性）。

**PWM有效极性：**

设置为PWM1，设置极性为高电平，即高电平有效。向上计数时，TIMx_CNT<TIMx_CCR1时通道1为有效电平，否则为无效电平；向下计数时，TIMx_CNT>TIMx_CCR1时通道1为无效电平，否则为有效电平。

设置为PWM2，设置极性为高电平，即高电平有效。向上计数时，TIMx_CNT<TIMx_CCR1时通道1为无效电平，否则为有效电平；向下计数时，TIMx_CNT>TIMx_CCR1时通道1为有效电平，否则为无效电平。

**注：PWM电平极性反转由硬件完成。**

**死区时间：**

$T_{DTS}=(1,2,4)T_{CK_INT}$ ， $T_{DTS}$ 为死区单位时间， $T_{CKT\_ CNT}$ 为计数器加1或减1的间隔时间；

![20240124162707](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124162707.png)


DTG[7:0]：死区时间设置寄存器。

当DTG[7:5]=0xx ，=> DT= DTG[7:0]* $T_{DTG}$ ； $T_{DTG}=T_{DTS}$

当DTG[7:5]=10x ，=> DT= (64+DTG[5:0])*  $T_{DTG}$ ； $T_{DTG}=2T_{DTS}$

当DTG[7:5]=110 ，=> DT= (32+DTG[4:0])*  $T_{DTG}$ ； $T_{DTG}=8T_{DTS}$

当DTG[7:5]=111 ，=> DT= (32+DTG[4:0])*  $T_{DTG}$ ； $T_{DTG}=16T_{DTS}$

如果 $T_{DTS}=125 ns（8Mhz）$ ,

**0 to 15875 ns by 125 ns steps;**

**16 us to 31750 ns by 250 ns steps;**

**32 us to 63 us by 1 us steps;**

**64 us to 126 us by 2us steps;**

逆变器上桥臂PWM：先高电平，后低电平，再高电平；

逆变器下桥臂PWM：先低电平，后高电平，再低电平；

![20240124163252](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124163252.png)

**ADC采样通道：**

三电阻采样或者两电阻采样，采样点在PWM波的中心位置。TIM1通道4设置为mode2，向上计数比较器中断，设置为ADC采样通道，将该通道的CCR值设置为（ARR-1）。因为ARR-1处对应三角波的中心，也是通道1/2/3生成的PWM波的中心。计数器计数到CNT=ARR-1时，通道4产生高电平，触发ADC采样。

定时器触发ADC采样，是属于外部触发转换的一种方式。当外部触发信号被选为ADC规则或注入转换时，只有它的上升沿可以启动转换。




