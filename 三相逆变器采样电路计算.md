# 三相逆变器采样电路计算

当使用三相逆变进行电机控制时，进场需要获取相电流进行闭环控制，这就涉及到电流采样的问题。常用的电流采样技术包括：采样电阻、霍尔元件、电流互感器。

![20240124145307](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124145307.png)

下面简单介绍下霍尔和电流互感器方法。

## 1、霍尔元件法

使用霍尔元件进行电流检测最大的优势是霍尔传感器与载流导体之间没有电气接触，导体的电位可偏置几百伏且确保传感器良好运行。因此，使用霍尔元件进行电流检测时都是直接测量相电流的，如图2所示。

图中的Current Sensor即是霍尔传感器。在此图中，使用了3个霍尔传感器来测量三相电流，但一般情况下，只需使用2个霍尔传感器即可。根据基尔霍夫电流定律，三相电流之和必为0，故可以通过两相的电流来推出第三相电流。

![20240124145400](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124145400.png)

开环霍尔元件直接检测由待测电流激发出的磁场磁感应强度；闭环霍尔元件则是在磁环上又缠绕了一组线圈，其中电流通过反馈确定，以保证最终磁环中的磁感应强度为0，这样通过测量线圈中电流的大小即可推算出待测电流的大小。 闭环霍尔元件与开环霍尔元件相比，其检测精度较高，并且在响应时间、带宽等指标上也优于开环霍尔元件；不过其缺点在于结构较为复杂，这也就导致了其体积较大且成本较高。

## 2、电路互感器

电流互感器其实就是一个变压器，它的一次侧绕组匝数很少，串在需要测量的电流的线路中，二次侧绕组匝数比较多，串接在测量仪表和保护回路中，电流互感器在工作时，它的二次侧回路始终是闭合的，因此测量仪表和保护回路串联线圈的阻抗很小，电流互感器的工作状态接近短路。电流互感器是把一次侧大电流转换成二次侧小电流来测量 ，二次侧不可开路。电流互感器一般用于电力电子系统中，而且一般是以一个仪表产品的形态出现。

![20240124145455](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124145455.png)

## 3、采样电阻法

在FOC算法中，电流反馈环节是相当重要的一部分，无论是有感FOC还是无感FOC，相电流是交流三相同步电机在进行坐标变换的关键，最终通过SVPWM实现电机转子磁场和定子磁场的同步转动，通常这里有三种方案：单电阻采样，双电阻采样，三电阻采样，关系到整体系统的成本、算法复杂度和最终运行的效果。

集中电流采样方案的对比：

|电流采样|成本| 算法  |
|-------|----|----|
|单电阻|低| 复杂  |
|双电阻|适中|适中|
|三电阻|高| 简单 |

在需要进行精确电流采样的场合，使用普通的两触点电阻就不合适了。由于采样电阻本身的阻值很小，焊料的电阻并不能忽略，它们不确定，且随温度变化，会影响测量输出。此时，应该选用4触点的采样电阻。不过在三相逆变器相电流采样的过程中，一般是不需要考虑这个问题的，使用普通的两触点电阻即可。

按照采样电阻放置位置不同，电阻采样方案可分为两大类——高端采样(High-Side Sensing)与低端采样(Low-Side Sensing)，其区别见下图4。

如图所示，高端采样中，采样电阻位于负载高端，即一端与电源连接；低端采样中，采样电阻位于负载低端，即一端与地平面相连接。

![20240124145935](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124145935.png)

### 3.1 高端采样

高端采样是一种较为昂贵的解决方案。对于三相逆变器电路，采样电阻直接置于相电流桥臂上即可，如图5所示.

![20240124150012](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124150012.png)

根据基尔霍夫电流定律，只需要测量两项的电流即可，另一相电流可通过计算得到。高端采样的优势在于：

（1）采样得到的电流值在任何时刻都等于相电流值，对于采样时刻无需特别考虑；

（2）因为使用类似差分输入的形式，可以很好的避免地平面噪声的干扰，检测精度高。

高端采样最大的劣势在于对后级处理电路的要求很高，后级运放要能承受很高的且急剧变化的共模电压，但这样的运放选择起来并不容易，因此这种方案普遍较为昂贵。

### 3.2 低端采样
$\bullet$ 三电阻采样

![20240124150230](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124150230.png)

$\bullet$ 两电阻采样

![20240124150242](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124150242.png)

$\bullet$ 单电阻采样

![20240124150259](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124150259.png)

其中最常用的是双电阻采样方案，在某些成本敏感的应用中，也会选用单电阻采样方案。低端采样的优势：

1）对运放没有特殊要求，选用常规通用运放即可；

2）成本低廉，特别是单电阻采样方案，具有较大的价格优势。

缺点：

1）由于开关管的存在，流经采样电阻的电流并不随时等于相电流，对采样时刻有严格的要求；

2）地平面噪声会影响采样的准确性。

采样的关键是需要在三相逆变器高端关闭，低端打开的情况下进行采样，这是整体的采样点。因此，采样会存在窗口时间，因为ADC转换完成需要一定数量级的时间，也就是说，在ADC转换完成之前，逆变桥的低端是不能关闭的，在这里双电阻和单电阻采样需要考虑窗口时间的限制，而三电阻采样则不存在窗口时间（PWM占空比接近100%），可以根据SVPWM当前所在象限，进行分类，只需要采集其中不受窗口时间限制的两相电流，然后根据  $I_a+I_b+I_c=0$  ，进行电流重构。

**（1）三电阻采样**

当下桥臂的开关管断开时，采样电阻是不会有电流流过的；只有当下桥臂开关管导通时，由于负载是感性负载，此时才会有电流从下桥臂，这个续流二极管就等于相电流。

![20240124152712](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124152712.png)

从上图可以看到，相电流是基本连续的，然而下桥臂电流是断续的，当且仅当下桥臂全部导通时（上桥臂SVPWM零矢量信号），流过下桥臂采样电阻才等于相电流。

三电阻采样可以避免窗口时间，如下图所示；在不同扇区需要采样的相电流，可以看到，共同点是避免采样PWM占空比接近100%的那一相电流，然后用其他两相的电流值来推出被丢弃采样值的相电流。因此，对于双电阻及三电阻采样方案而言，只需要在SVPWM的零矢量（000）中央处进行采样即可获得正确的相电流。

![20240124152743](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124152743.png)

参考ST电机库的做法，通过TIMER_CH4作为ADC采样的出发信号，而采样则可以通过修改TIM_CCR4寄存器取改变采样点。

![20240124152813](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124152813.png)

1）配置TIMER CH4为TRGO输出；

2）TIMER的TRGO输出用于硬件出发ADC采样；

3）如果是拥有两个ADC模块的可以同时触发进行同时采样；

4）判断波形的采样位置，修正CCR4数据；

**（2）两电阻采样**

双电阻采样无法避免窗口时间，采样过程中某一相一定会在零矢量遇见小窗口时间，所以需要限制最终PWM的占空比（不能太大），为ADC转换预留足够的时间（小于小窗口时间）。
和三电阻采样类似，只需要在SVPWM的零矢量（000）中央处进行采样即可获得正确的相电流。采样时刻示意图见下面这两张图。

![20240124152852](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124152852.png)![20240124152901](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124152901.png)

双电阻采样的情况下，可以通过电流平衡条件推算出第三相的电流,在某些情况下（如SVPWM几个扇区的交界处），采样窗口时间会变得很短。三电阻采样则不存在此问题。

**（3）单电阻采样**

该方案是通过在一个PWM周期内进行两次AD采样实现相电流检测的，其采样时刻如下图所示。

![20240124153005](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124153005.png)

![20240124153021](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124153021.png)

)![20240124153027](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124153027.png)

图中T1和T2阶段就是采样时刻。和两点组、三电阻采样方案相反，单电阻的采样时刻要使得下桥臂不能全断开和全闭合。（电流正负以中性点为准）

![20240124153115](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124153115.png)

单电阻采样方案存在一些不允许单分流三相重构的特殊情形。在SVPWM中，有时候会输出两路占空比相等的PWM信号，此时T2=0，此时只能得到一相的相电流，无法重构得到三相电流信息。除此之外，死区时间等因素也会影响采样窗口。

**4、采样电路计算原理**

在实际使用中，采样电阻是比较小的（mohm），这导致电阻两端的压降也会比较小。如果直接传递到ADC采样部分，不太合适。可以对采样的电压进行放大处理，具体的电路如下：

![20240124153215](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124153215.png)

$U_{out}$ 电压经过RC滤波电路，与TVS管保护，输入到MCU的ADC保护模块，湖区电压值。进而得到采样电阻 $R_{ref}$ 两端放大后的电压值。之后，可以计算出电流值。

$$I_{smaple}=\frac{U_{in+}-U_{in-}}{R_{ref}}$$

由于放大器的虚短与虚断特性，以上电路有以下特点：

**虚断：**

流经放大器的正负极的电流 $I\approx0$ ，则流经电阻 $R_1$ 与 $R_3$ 的电流基本相等。流经 $R_2$ 与 $R_4$ 的电流基本相等。

放大器负极 $U_{-}$ 的电压，可以计算为：

$$U_{-}=\frac{U_{in+}}{R1+R3}R3$$

放大器正极 $U_{+}$ 的电压，可以计算为：

$$U_{+}=\frac{U_{in-}-U_{out}}{R2+R4}R4+U_{out}$$

**虚短：**

$U_{-}\approx U_{+}$ ；这里假设  $R1=R2,R3=R4$ ，则有

$$\frac{U_{in+}}{R1+R3}R3=\frac{U_{in-}-U_{out}}{R2+R4}R4+U_{out}$$

$$U_{out}=\frac{R3(U_{in+}-U_{in-})}{R1}$$

**安全电路**

图中安全电路有两处。

第一个，RC滤波电路，实现将高频干扰滤除，避免 $U_{out}$ 变化过快。但是电阻R与MCU的内阻实现分压，则实际上MCU的采样电压要比 $U_{out}$ 小一些，这个可以从代码层面补偿。

第二个，TVS保护电路。MCU的管脚输入电压有上限值，使用TVS箝位，避免出现过高电压输入到mcu管脚，造成GPIO损坏。

选型原则：

选型时，主要考虑满载的电流损耗，选择具体的采样电阻与放大倍数组合。

这里放大倍数等于 $K=R3/R1$ ，采样电阻 $R_{ref}$ ，当MCU的ADC电压达到最大值，这里取3.3V。

取 $K=100,R_{ref}=0.01ohm$ ，则满载电流最大： $I_{max}=3.3/(100*0.01)=3.3A$ 。

**计算示例：**

现在以采样电阻法中的低端采样为例，计算三相逆变器的相电流（设计偏置电路主要是考虑三相逆变桥存在负电流）。

![20240124154426](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124154426.png)

计算：

![20240124154534](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124154534.png)


MCU adc采样电压：  $U_{out}$

三相逆变器下桥臂电流：  $T_s$

**5、三电阻采样实际电路设计**

三电阻采样，使用了偏置电路和放大电路。

![20240124154726](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124154726.png)

![20240124154741](https://cdn.jsdelivr.net/gh/xupengfeir/Notes-and-Articles/Image/20240124154741.png)


## 参考资料

[1]https://www.cnblogs.com/zhuliushun001/p/17642905.html
[2]https://zhuanlan.zhihu.com/p/347212620
[3]https://github.com/g199209/BlogMarkdown/blob/master/%E4%B8%89%E7%9B%B8%E9%80%86%E5%8F%98%E5%99%A8%E7%94%B5%E6%B5%81%E9%87%87%E6%A0%B7%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93.md




